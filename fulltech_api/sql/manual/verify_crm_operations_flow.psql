-- ============================================================================
-- Script PSQL (NO MIGRATION): VerificaciÃ³n de Flujo CRM â†’ Operaciones
-- ============================================================================
-- IMPORTANTE:
--   Este archivo usa comandos de psql como \echo y \gx.
--   No es compatible con el runner Node/pg (client.query). Por eso vive en
--   sql/manual/ y tiene extensiÃ³n .psql.
--
-- Uso (ejemplo):
--   psql "$DATABASE_URL" -v chat_id='...' -v empresa_id='...' -f sql/manual/verify_crm_operations_flow.psql
-- ============================================================================

-- ============================================================================
-- Script SQL: VerificaciÃ³n de Flujo CRM â†’ Operaciones
-- ============================================================================
-- Este script verifica que al marcar un chat con estado "agendado" o 
-- "por_levantamiento", toda la informaciÃ³n se crea correctamente en el
-- mÃ³dulo de operaciones en la sesiÃ³n correcta.
-- ============================================================================

-- ConfiguraciÃ³n: Reemplaza estos valores con tus datos de prueba
-- \set chat_id 'tu-chat-id-aqui'
-- \set empresa_id 'tu-empresa-id-aqui'

\echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
\echo 'â•‘  VERIFICACIÃ“N: FLUJO CRM â†’ OPERACIONES                                â•‘'
\echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
\echo ''

-- ============================================================================
-- 1. VERIFICAR CHAT Y SU ESTADO
-- ============================================================================
\echo '1ï¸âƒ£  CHAT SELECCIONADO'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

SELECT 
  id,
  empresa_id,
  wa_id,
  phone,
  display_name,
  status,
  scheduled_at,
  location_text,
  assigned_tech_id,
  service_id,
  updated_at
FROM crm_chat
WHERE id = :'chat_id'
\gx

-- ============================================================================
-- 2. VERIFICAR CLIENTE CREADO
-- ============================================================================
\echo ''
\echo '2ï¸âƒ£  CLIENTE ASOCIADO'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

-- Buscar cliente por telÃ©fono del chat
WITH chat_info AS (
  SELECT 
    id,
    empresa_id,
    phone,
    COALESCE(phone, '+' || wa_id) as phone_search
  FROM crm_chat
  WHERE id = :'chat_id'
)
SELECT 
  c.id,
  c.empresa_id,
  c.nombre,
  c.telefono,
  c.origen,
  c.direccion,
  c.ubicacion_mapa,
  c.created_at,
  CASE 
    WHEN c.empresa_id = ci.empresa_id THEN 'âœ… Correcto'
    ELSE 'âŒ ERROR: empresa_id no coincide'
  END as empresa_check
FROM customer c
CROSS JOIN chat_info ci
WHERE c.telefono LIKE '%' || RIGHT(ci.phone_search, 10) || '%'
  AND c.deleted_at IS NULL
ORDER BY c.created_at DESC
LIMIT 1
\gx

-- ============================================================================
-- 3. VERIFICAR JOBS DE OPERACIONES
-- ============================================================================
\echo ''
\echo '3ï¸âƒ£  JOBS DE OPERACIONES'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

SELECT 
  oj.id,
  oj.empresa_id,
  oj.crm_chat_id,
  oj.crm_customer_id,
  oj.crm_task_type,
  oj.status,
  oj.customer_name,
  oj.customer_phone,
  oj.service_type,
  oj.scheduled_at,
  oj.location_text,
  oj.lat,
  oj.lng,
  oj.assigned_tech_id,
  oj.service_id,
  oj.notes,
  oj.created_at,
  oj.updated_at,
  CASE 
    WHEN oj.crm_chat_id = :'chat_id' THEN 'âœ… Correcto'
    ELSE 'âŒ ERROR: chat_id no coincide'
  END as chat_check,
  CASE 
    WHEN oj.empresa_id = :'empresa_id' THEN 'âœ… Correcto'
    ELSE 'âŒ ERROR: empresa_id no coincide'
  END as empresa_check
FROM operations_jobs oj
WHERE oj.crm_chat_id = :'chat_id'
  AND oj.deleted_at IS NULL
ORDER BY oj.created_at DESC
\gx

-- ============================================================================
-- 4. CONTAR JOBS ACTIVOS (VERIFICAR NO HAY DUPLICADOS)
-- ============================================================================
\echo ''
\echo '4ï¸âƒ£  VERIFICACIÃ“N DE DUPLICADOS'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

SELECT 
  crm_task_type,
  COUNT(*) as cantidad,
  CASE 
    WHEN COUNT(*) = 1 THEN 'âœ… Correcto (sin duplicados)'
    WHEN COUNT(*) > 1 THEN 'âŒ ERROR: Jobs duplicados!'
    ELSE 'âš ï¸  No hay jobs de este tipo'
  END as estado
FROM operations_jobs
WHERE crm_chat_id = :'chat_id'
  AND deleted_at IS NULL
  AND status NOT IN ('completed', 'closed', 'cancelled')
GROUP BY crm_task_type
ORDER BY crm_task_type;

-- ============================================================================
-- 5. VERIFICAR SCHEDULE (PARA SERVICIOS AGENDADOS)
-- ============================================================================
\echo ''
\echo '5ï¸âƒ£  SCHEDULE DE OPERACIONES'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

SELECT 
  os.id,
  os.job_id,
  os.scheduled_date,
  os.preferred_time,
  os.assigned_tech_id,
  os.additional_tech_ids,
  os.customer_availability_notes,
  oj.crm_task_type,
  CASE 
    WHEN oj.crm_task_type IN ('LEVANTAMIENTO', 'SERVICIO_RESERVADO') 
    THEN 'âœ… Tipo correcto para schedule'
    ELSE 'âš ï¸  Tipo inesperado'
  END as tipo_check
FROM operations_schedule os
JOIN operations_jobs oj ON os.job_id = oj.id
WHERE oj.crm_chat_id = :'chat_id'
  AND oj.deleted_at IS NULL
ORDER BY os.scheduled_date DESC
\gx

-- ============================================================================
-- 6. VERIFICAR TÃ‰CNICO ASIGNADO
-- ============================================================================
\echo ''
\echo '6ï¸âƒ£  TÃ‰CNICO ASIGNADO'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

SELECT 
  u.id,
  u.empresa_id,
  u.nombre_completo,
  u.email,
  u.rol,
  u.telefono,
  u.estado,
  CASE 
    WHEN u.estado = 'activo' THEN 'âœ… Activo'
    ELSE 'âš ï¸  Inactivo'
  END as estado_check,
  CASE 
    WHEN u.empresa_id = :'empresa_id' THEN 'âœ… Empresa correcta'
    ELSE 'âŒ ERROR: empresa_id no coincide'
  END as empresa_check
FROM usuario u
WHERE u.id IN (
  SELECT assigned_tech_id 
  FROM operations_jobs 
  WHERE crm_chat_id = :'chat_id' 
    AND deleted_at IS NULL
)
\gx

-- ============================================================================
-- 7. VERIFICAR SERVICIO ASOCIADO
-- ============================================================================
\echo ''
\echo '7ï¸âƒ£  SERVICIO ASOCIADO'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

SELECT 
  s.id,
  s.empresa_id,
  s.name,
  s.descripcion,
  s.precio_base,
  s.duracion_estimada_horas,
  s.is_active,
  CASE 
    WHEN s.is_active = true THEN 'âœ… Activo'
    ELSE 'âš ï¸  Inactivo'
  END as estado_check,
  CASE 
    WHEN s.empresa_id = :'empresa_id' THEN 'âœ… Empresa correcta'
    ELSE 'âŒ ERROR: empresa_id no coincide'
  END as empresa_check
FROM service s
WHERE s.id IN (
  SELECT service_id 
  FROM operations_jobs 
  WHERE crm_chat_id = :'chat_id' 
    AND deleted_at IS NULL
)
\gx

-- ============================================================================
-- 8. HISTORIAL DE CAMBIOS
-- ============================================================================
\echo ''
\echo '8ï¸âƒ£  HISTORIAL DE CAMBIOS'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

SELECT 
  ojh.id,
  ojh.job_id,
  ojh.action_type,
  ojh.old_status,
  ojh.new_status,
  ojh.note,
  ojh.created_at,
  u.nombre_completo as created_by
FROM operations_job_history ojh
LEFT JOIN usuario u ON ojh.created_by_user_id = u.id
WHERE ojh.job_id IN (
  SELECT id 
  FROM operations_jobs 
  WHERE crm_chat_id = :'chat_id'
)
ORDER BY ojh.created_at DESC
LIMIT 10
\gx

-- ============================================================================
-- 9. VERIFICAR WARRANTY TICKETS (SI APLICA)
-- ============================================================================
\echo ''
\echo '9ï¸âƒ£  TICKETS DE GARANTÃA'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

SELECT 
  owt.id,
  owt.job_id,
  owt.reason,
  owt.status,
  owt.assigned_tech_id,
  owt.reported_at,
  owt.resolved_at,
  oj.crm_task_type,
  CASE 
    WHEN oj.crm_task_type = 'GARANTIA' THEN 'âœ… Tipo correcto'
    ELSE 'âš ï¸  Tipo no es garantÃ­a'
  END as tipo_check
FROM operations_warranty_tickets owt
JOIN operations_jobs oj ON owt.job_id = oj.id
WHERE oj.crm_chat_id = :'chat_id'
ORDER BY owt.reported_at DESC
\gx

-- ============================================================================
-- 10. RESUMEN GENERAL
-- ============================================================================
\echo ''
\echo 'ğŸ”Ÿ RESUMEN GENERAL'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

WITH job_stats AS (
  SELECT 
    COUNT(*) as total_jobs,
    COUNT(DISTINCT crm_customer_id) as unique_customers,
    COUNT(DISTINCT crm_task_type) as unique_types,
    COUNT(*) FILTER (WHERE status NOT IN ('completed', 'closed', 'cancelled')) as active_jobs,
    COUNT(*) FILTER (WHERE crm_task_type = 'LEVANTAMIENTO') as levantamiento_jobs,
    COUNT(*) FILTER (WHERE crm_task_type = 'SERVICIO_RESERVADO') as servicio_jobs,
    COUNT(*) FILTER (WHERE crm_task_type = 'GARANTIA') as garantia_jobs,
    MIN(created_at) as first_job_at,
    MAX(updated_at) as last_update_at
  FROM operations_jobs
  WHERE crm_chat_id = :'chat_id'
    AND deleted_at IS NULL
),
customer_info AS (
  SELECT 
    COUNT(*) as customer_count
  FROM customer c
  WHERE c.telefono IN (
    SELECT COALESCE(phone, '+' || wa_id)
    FROM crm_chat
    WHERE id = :'chat_id'
  )
  AND c.deleted_at IS NULL
)
SELECT 
  js.total_jobs as "Total Jobs",
  js.active_jobs as "Jobs Activos",
  js.unique_customers as "Clientes Ãšnicos",
  ci.customer_count as "Clientes en DB",
  js.levantamiento_jobs as "Jobs Levantamiento",
  js.servicio_jobs as "Jobs Servicio",
  js.garantia_jobs as "Jobs GarantÃ­a",
  js.first_job_at as "Primer Job",
  js.last_update_at as "Ãšltima ActualizaciÃ³n",
  CASE 
    WHEN js.active_jobs > 0 THEN 'âœ… Hay jobs activos'
    ELSE 'âš ï¸  No hay jobs activos'
  END as "Estado",
  CASE 
    WHEN ci.customer_count > 0 THEN 'âœ… Cliente existe'
    ELSE 'âŒ ERROR: Cliente no encontrado'
  END as "Cliente Check"
FROM job_stats js
CROSS JOIN customer_info ci
\gx

-- ============================================================================
-- 11. VERIFICACIÃ“N FINAL: CHECKLIST
-- ============================================================================
\echo ''
\echo 'âœ… CHECKLIST DE VERIFICACIÃ“N'
\echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'

SELECT 
  CASE WHEN EXISTS (
    SELECT 1 FROM crm_chat WHERE id = :'chat_id'
  ) THEN 'âœ…' ELSE 'âŒ' END || ' Chat existe' as check_1,
  
  CASE WHEN EXISTS (
    SELECT 1 FROM customer c
    WHERE c.telefono LIKE '%' || (
      SELECT RIGHT(COALESCE(phone, '+' || wa_id), 10)
      FROM crm_chat WHERE id = :'chat_id'
    ) || '%'
    AND c.deleted_at IS NULL
  ) THEN 'âœ…' ELSE 'âŒ' END || ' Cliente fue creado' as check_2,
  
  CASE WHEN EXISTS (
    SELECT 1 FROM operations_jobs
    WHERE crm_chat_id = :'chat_id'
      AND deleted_at IS NULL
  ) THEN 'âœ…' ELSE 'âŒ' END || ' Job existe' as check_3,
  
  CASE WHEN (
    SELECT COUNT(*) FROM operations_jobs
    WHERE crm_chat_id = :'chat_id'
      AND deleted_at IS NULL
      AND status NOT IN ('completed', 'closed', 'cancelled')
  ) <= 3 THEN 'âœ…' ELSE 'âš ï¸ ' END || ' Sin duplicados excesivos' as check_4,
  
  CASE WHEN EXISTS (
    SELECT 1 FROM operations_jobs oj
    JOIN crm_chat cc ON oj.crm_chat_id = cc.id
    WHERE oj.crm_chat_id = :'chat_id'
      AND oj.empresa_id = cc.empresa_id
      AND oj.deleted_at IS NULL
  ) THEN 'âœ…' ELSE 'âŒ' END || ' empresa_id correcto' as check_5,
  
  CASE WHEN EXISTS (
    SELECT 1 FROM operations_jobs
    WHERE crm_chat_id = :'chat_id'
      AND assigned_tech_id IS NOT NULL
      AND deleted_at IS NULL
  ) THEN 'âœ…' ELSE 'âš ï¸ ' END || ' TÃ©cnico asignado' as check_6,
  
  CASE WHEN EXISTS (
    SELECT 1 FROM operations_jobs
    WHERE crm_chat_id = :'chat_id'
      AND service_id IS NOT NULL
      AND deleted_at IS NULL
  ) THEN 'âœ…' ELSE 'âš ï¸ ' END || ' Servicio asociado' as check_7,
  
  CASE WHEN EXISTS (
    SELECT 1 FROM operations_jobs
    WHERE crm_chat_id = :'chat_id'
      AND scheduled_at IS NOT NULL
      AND deleted_at IS NULL
  ) THEN 'âœ…' ELSE 'âš ï¸ ' END || ' Fecha programada' as check_8;

\echo ''
\echo 'â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—'
\echo 'â•‘  VERIFICACIÃ“N COMPLETADA                                              â•‘'
\echo 'â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
\echo ''
\echo 'Leyenda:'
\echo '  âœ… = Verificado correctamente'
\echo '  âŒ = Error encontrado'
\echo '  âš ï¸  = Advertencia (puede ser normal segÃºn el caso)'
\echo ''
